# 컨텍스트 스위칭 (Context Switching)

## 학습 목표

- [ ] 컨텍스트 스위칭의 개념을 설명할 수 있다
- [ ] 프로세스 vs 스레드 스위칭 비용 차이를 안다
- [ ] 성능 최적화 관점에서 스위칭 비용을 이해한다

---

## 1. 컨텍스트 스위칭이란?

### 정의
운영체제 커널이 CPU 제어권을 하나의 프로세스(또는 스레드)에서 다른 것으로 넘기는 과정

### 발생 시점
- 타임 슬라이스 만료
- I/O 요청으로 인한 대기
- 인터럽트 발생
- 시스템 콜 호출

---

## 2. 컨텍스트 스위칭 과정

```
┌─────────────────────────────────────────────────────┐
│                    Process A 실행 중                 │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│  1. Process A의 상태(컨텍스트)를 PCB에 저장          │
│     - PC (Program Counter)                          │
│     - CPU 레지스터                                   │
│     - 메모리 관리 정보                               │
│     - I/O 상태 정보                                  │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│  2. Process B의 상태를 PCB에서 복원                  │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│                    Process B 실행 중                 │
└─────────────────────────────────────────────────────┘
```

---

## 3. 프로세스 vs 스레드 컨텍스트 스위칭

### 프로세스 간 스위칭 (비용 높음)

| 작업 | 설명 |
|------|------|
| 메모리 주소 공간 전환 | 페이지 테이블 교체 필요 |
| TLB 플러시 | 가상 주소 → 물리 주소 캐시 무효화 |
| CPU 캐시 미스 | L1, L2, L3 캐시 적중률 저하 |

### 스레드 간 스위칭 (비용 낮음)

| 작업 | 설명 |
|------|------|
| 레지스터만 교체 | Stack 포인터, PC 등 |
| 메모리 공유 | TLB 플러시 불필요 |
| 캐시 유지 | 공유 메모리로 캐시 적중률 유지 |

---

## 4. 비용 비교

```
컨텍스트 스위칭 비용 비교
├── 프로세스 스위칭: ~1000-10000 CPU 사이클
│   ├── PCB 저장/복원
│   ├── 메모리 매핑 변경
│   ├── TLB 플러시
│   └── 캐시 미스 페널티
│
└── 스레드 스위칭: ~100-1000 CPU 사이클
    ├── TCB 저장/복원
    └── 레지스터 교체
```

---

## 5. 실무 적용

### 면접 질문 예시
> "대용량 트래픽 처리 시 왜 멀티 프로세스(PHP-FPM)보다 멀티 스레드(Java Spring)가 선호되는가?"

### 답변 포인트
1. 스레드 컨텍스트 스위칭 비용이 낮음
2. 메모리 공유로 IPC 오버헤드 없음
3. 스레드 풀을 통한 효율적 리소스 관리

### 반대 사례: 크롬 브라우저
- 탭마다 별도 프로세스 사용
- **이유**: 안정성 (한 탭 크래시가 전체에 영향 없음)
- **트레이드오프**: 메모리 사용량 증가

---

## 6. 최적화 전략

1. **스레드 풀 사용**: 스레드 생성/소멸 비용 절감
2. **비동기 I/O**: 블로킹으로 인한 스위칭 최소화
3. **CPU 친화도 설정**: 특정 코어에 스레드 바인딩
4. **캐시 효율성 고려**: 데이터 지역성 활용

---

## 연관 개념

- [프로세스와 스레드](./01-process-thread.md)
- [Virtual Threads](../../02-backend-engineering/java-fundamentals/05-java21-virtual-threads.md)
